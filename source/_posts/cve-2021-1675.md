title: CVE-2021-1675
date: 2021-06-22 05:14:35
tags: [cve,windows,exp]
---
# 漏洞详情
Windows Print Spooler 特权提升漏洞

# 补丁
KB5003637:`windows10.0-kb5003637-x64_fd175a387e2f07586d85899a75d0bf10120a3c2c.msu`

## 解压补丁
win10(应该是win8后某个时间点后)和win7之流的补丁不一样, 它变小了
  - 方法1 [MSDelta](https://docs.microsoft.com/en-us/windows/win32/devnotes/msdelta)
  - 方法2 `C:\windows\WinSxS\`

## 获取文件
![所需文件](https://docs.microsoft.com/en-us/windows-hardware/drivers/print/images/spoocomp.png)
<!--more-->
```
+---1052
|       FaxPrinterInstaller.dll
|       localspl.dll
|       splwow64.exe
|       spoolsv.exe
|       winprint.dll
|       winspool.drv
|
+---867
|       FaxPrinterInstaller.dll
|       localspl.dll
|       splwow64.exe
|       spoolsv.exe
|       winprint.dll
```

## 对比
针对`localspl.dll`

### 新增函数
```
0000000180042780	GetApprovedPrinterList(ushort const *)	14	47	21
0000000180042840	IsDeviceControlEnabled(ushort const *)	10	50	15
00000001800428F4	IsPrinterApproved(_INIPRINTER *,ushort *)	33	172	53
00000001800486A4	GetSpoolerStringPolicy	16	88	23
00000001800487F8	GetUserSpoolerPolicy	15	75	23
0000000180048924	GetUserSpoolerStringPolicy	17	99	25
0000000180073F6C	NCoreLibrary::TAutoHandleHKEY::~TAutoHandleHKEY(void)	3	12	3
00000001800DB130	NCoreLibrary::TAutoHandleHKEY::TAutoHandleHKEY(HKEY__ *)	1	10	0
```

### 修改函数
```
0.28	0.39	GI--EL-	IsLocalFile
0.84	0.98	GI-----	GetSpoolerPolicy
0.94	0.99	GI--E--	PrintingDirectlyToPort
0.95	0.99	GI-JE--	LocalSendRecvBidiData
0.96	0.98	GI-J---	InitializePrintProvidor
```
### 对比补丁函数
共五个函数改变

#### isLocalFile
此函数修改了流程, 增加了首先将 `/` 替换为 `\` 的流程

#### GetSpoolerPolicy
此函数实际无改变, 一个`NCoreLibrary::HResultFromWin32`内联了

#### PrintingDirectlyToPort
增加了`IsDeviceControlEnabled`判断, 与所有新增函数都有关, 关键字为 "USB"

#### InitializePrintProvidor
多初始化了几个全局变量, 且在PrintingDirectlyToPort中使用
  - g_pszDCPNonUsbPrint
  - g_pszDCPNoApprovedUsbPolicy
  - g_pszDCPUsbPrinterNotApproved



#### LocalSendRecvBidiData
做了一些操作 其中有部分判断了 `pAction` 赋值为 `L"GetAll"(BIDI_ACTION_GET_ALL)` 或者`L"GetFromPortMon"`

## 对于isLocalFile修改的分析
<!--参考`CVE-2020-1048/CVE-2020-1337 CVE-2016-3238 CVE-2020-1030`-->
调用链:`isLocalFile <--  ValidateDriverInfo <-- InternalAddPrinterDriverEx <-- SplAddPrinterDriverEx <-- localspl.dll`
关键字`AddPrinterDriverEx`, 在powershell中调用`Add-PrinterDriver`后, 查看调用栈:

```
0:008> kb
RetAddr           : Args to Child : Call Site
00007fff`3e0cb8fc : ......        : localspl!IsLocalFile
00007fff`3e0cd2a7 : ......        : localspl!ValidateDriverInfo+0x438
00007fff`3e1096bf : ......        : localspl!InternalAddPrinterDriverEx+0x1f3
00007fff`3e10806e : ......        : localspl!NPackageInstallLocalspl::LegacyInstallPrinterDriverFromPackage+0x71f
00007fff`3e10b637 : ......        : localspl!NPackageInstallLocalspl::InternalInstallPrinterDriverFromPackage+0x66b6
00007fff`3e101955 : ......        : localspl!SplInstallPrinterDriverFromPackage+0x127
00007ff7`a1edd40f : ......        : localspl!NPackageInstallLocalspl::TPackageInstallLocalspl::InstallDriver+0x95
00007ff7`a1eb6096 : ......        : spoolsv!RouterInstallPrinterDriverFromPackage+0x6f
00007ff7`a1eb207a : ......        : spoolsv!YInstallPrinterDriverFromPackage+0x46
00007fff`6da6a0e3 : ......        : spoolsv!RpcInstallPrinterDriverFromPackage+0x4a
......
```

查看`ValidateDriverInfo`函数, 发现检查了`driver_info.pDriverPath`与`driver_info.pConfigFile`, 其中若`isLocalFile`检查失败则直接失败退出.
其中`isLocalFile`中的流程易得判断是否为UNC路径, 即`\\PDC-01.xz\c$\path\to\driver`, 根据补丁易得修复了类似于`//PDC-01.xz\c$\path\to\driver`的绕过方法.

参考[文档](https://docs.microsoft.com/en-us/windows/win32/printdocs/addprinterdriverex), 尝试后发现**管理员权限**下可对*指定路径*dll进行加载, 且无需数字签名. 

其中指定路径为系统自带驱动所在路径, 可以使用`../`绕过.

## 非管理员权限
安装`Generic / Text Only`时并不需要管理员权限即可安装, 尝试设置相应结构体为`Generic / Text Only`对应的文件, 发现`AddPrinterDriverEx`依然需要管理员权限.

下断回溯后仔细观察发现`InstallPrinterDriverFromPackage`无需管理权限, 进一步观察发现关键为`APD_STILL_INSTALL_WARNING_DRIVER`

验证后发现如预期执行, 至此利用成功

# 新版本修复
除了`localspl!IsLocalFile`外, `winspool!RpcAddPrinterDriverEx`亦使用`RunningAsLUA`判断后去除了`dwFileCopyFlags`中的`APD_STILL_INSTALL_WARNING_DRIVER`

也就是说除非绕过`RunningAsLUA`否则不能以非管理员利用

# poc
哈哈 太菜了拿不出手

# <span style="font-size:14px">参考资料</span>
<!--反正这里都要点就不写标题了-->
[title](https://i.blackhat.com/USA-20/Thursday/us-20-Hadar-A-Decade-After-Stuxnet-Printer-Vulnerability-Printing-Is-Still-The-Stairway-To-Heaven-wp.pdf)
[title](https://github.com/KernelPanic-OpenSource/Win2K3_NT_printscan)
[title](https://www.anquanke.com/post/id/205459)
[title](https://github.com/pyiesone/CVE-2016-3238-PoC/blob/master/CVE-2016-3238_MS16-087.pdf)
[title](https://www.accenture.com/us-en/blogs/cyber-defense/discovering-exploiting-shutting-down-dangerous-windows-print-spooler-vulnerability)
[title](https://blog.0patch.com/2021/02/print-spooler-keeps-delivering.html)
[title](https://www.vectra.ai/blogpost/own-a-printer-own-a-network-with-point-and-print-drive-by)
[title](https://windows-internals.com/printdemon-cve-2020-1048/)
[title](https://www.cnblogs.com/goabout2/p/13971925.html)